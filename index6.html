<script>
    let chart;
  
    function timeToMinutes(timeStr) {
      const [h, m] = timeStr.split(":").map(Number);
      return h * 60 + m;
    }
  
    function formatMinutesPerUnit(paceMin) {
      const min = Math.floor(paceMin);
      const sec = Math.round((paceMin - min) * 60);
      return `${min}:${sec.toString().padStart(2, "0")}`;
    }
  
    const stagesMiles = [
      { stage: 1, adj: 1 },
      { stage: 4, adj: 0.5 },
      { stage: 7, adj: 0.25 },
      { stage: 10, adj: 0 },
      { stage: 15, adj: -0.08 },
      { stage: 20, adj: -0.08 },
      { stage: 24, adj: 0 },
      { stage: 26.2, adj: null }
    ];
  
    const stagesKm = [
      { stage: 1, adj: 1 },
      { stage: 5, adj: 0.5 },
      { stage: 10, adj: 0.25 },
      { stage: 15, adj: 0 },
      { stage: 25, adj: -0.08 },
      { stage: 32, adj: -0.08 },
      { stage: 38, adj: 0 },
      { stage: 42.2, adj: null }
    ];
  
    // ðŸ”µ Agregado: descripciones por stage
    const stageNotes = [
      "60 seconds slower than goal pace",
      "30 seconds slower than goal pace",
      "15 seconds slower than goal pace",
      "Settle into goal pace",
      "Gently pick it up to 5â€“10 seconds faster than goal pace",
      "5â€“10 seconds faster than goal pace",
      "Try to hold on to goal pace",
      "Dig deep and finish strong!"
    ];
  
    function updateTable() {
      const input = document.getElementById("goalTime").value;
      const unit = document.getElementById("unitSelect").value;
      if (!/^\d{1,2}:\d{2}$/.test(input)) return;
  
      const totalMinutes = timeToMinutes(input);
      const pacePerMile = totalMinutes / 26.2;
      const pacePerKm = totalMinutes / 42.2;
      const stages = unit === "miles" ? stagesMiles : stagesKm;
      const pace = unit === "miles" ? pacePerMile : pacePerKm;
  
      let html = `
        <table>
          <thead>
            <tr><th>Stage (${unit})</th><th>Pace (min/${unit})</th><th>Description</th></tr>
          </thead>
          <tbody>
      `;
  
      const labels = [];
      const data = [];
  
      for (let i = 0; i < stages.length; i++) {
        const s = stages[i];
        let displayPace;
        if (s.adj === null) {
          // ðŸ”µ Al Ãºltimo stage le asignamos mismo ritmo que el anterior
          displayPace = formatMinutesPerUnit(pace + stages[i - 1].adj);
        } else {
          const currentPace = pace + s.adj;
          displayPace = formatMinutesPerUnit(currentPace);
          labels.push(s.stage);
          data.push(currentPace);
        }
        const note = stageNotes[i] || ""; // por si no hay descripciÃ³n disponible
        html += `<tr>
          <td>${s.stage}</td>
          <td class="${s.adj === 0 ? 'highlight' : ''}">${displayPace}</td>
          <td>${note}</td>
        </tr>`;
      }
  
      html += `</tbody></table>`;
      document.getElementById("paceTable").innerHTML = html;
  
      // Draw chart
      if (chart) chart.destroy();
      const ctx = document.getElementById('paceChart').getContext('2d');
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: `Pace (min/${unit})`,
            data: data,
            fill: false,
            borderColor: '#3b82f6',
            backgroundColor: '#3b82f6',
            tension: 0.3,
            pointRadius: 5
          }]
        },
        options: {
          responsive: true,
          plugins: {
            annotation: {
              annotations: {
                goalLine: {
                  type: 'line',
                  yMin: pace,
                  yMax: pace,
                  borderColor: 'red',
                  borderWidth: 2,
                  label: {
                    content: 'Goal Pace',
                    enabled: true,
                    position: 'start'
                  }
                }
              }
            }
          },
          scales: {
            y: {
              reverse: true,
              title: {
                display: true,
                text: `Pace (min/${unit})`
              }
            },
            x: {
              type: 'linear',
              title: {
                display: true,
                text: `Distance (${unit})`
              },
              ticks: {
                callback: function(value) {
                  return labels.includes(value) ? value : '';
                },
                stepSize: 1
              }
            }
          }
        }
      });
    }
  
    document.getElementById("goalTime").addEventListener("input", updateTable);
    document.getElementById("unitSelect").addEventListener("change", updateTable);
  </script>
  